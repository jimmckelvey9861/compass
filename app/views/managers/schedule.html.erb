<%# Container %>
<div class="container mx-auto px-4 py-6">
  <%# Header Section %>
  <div class="flex flex-col sm:flex-row justify-between items-center mb-6">
    <h1 class="text-2xl font-bold text-gray-800 mb-4 sm:mb-0">Weekly Schedule</h1>
    
    <%# Week Navigation %>
    <div class="flex items-center space-x-4">
      <%= link_to managers_schedule_path(week_start: @week_start - 1.week), 
          class: "px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200" do %>
        <span class="text-gray-600">← Previous Week</span>
      <% end %>
      
      <span class="text-gray-800 font-semibold">
        <%= @week_start.strftime("%B %d") %> - <%= @week_end.strftime("%B %d, %Y") %>
      </span>
      
      <%= link_to managers_schedule_path(week_start: @week_start + 1.week),
          class: "px-4 py-2 bg-gray-100 rounded-lg hover:bg-gray-200" do %>
        <span class="text-gray-600">Next Week →</span>
      <% end %>
    </div>
  </div>

  <%# Schedule Grid %>
  <div class="bg-white rounded-lg shadow overflow-x-auto">
    <div class="min-w-[800px]"> <%# Minimum width to prevent squishing %>
      <%# Grid Header - Days %>
      <div class="grid grid-cols-8 border-b">
        <div class="p-4 border-r bg-gray-50">
          <span class="text-gray-500 font-medium">Time</span>
        </div>
        <% @week_start.upto(@week_end).each do |date| %>
          <div class="p-4 border-r bg-gray-50 text-center">
            <div class="font-medium text-gray-800"><%= date.strftime("%A") %></div>
            <div class="text-sm text-gray-500"><%= date.strftime("%m/%d") %></div>
          </div>
        <% end %>
      </div>

      <%# Time Slots and Shifts %>
      <% (6..22).each do |hour| %>
        <div class="grid grid-cols-8 border-b">
          <%# Time Column %>
          <div class="p-4 border-r bg-gray-50">
            <span class="text-gray-500">
              <%= "#{hour == 12 ? 12 : hour % 12}:00 #{hour >= 12 ? 'PM' : 'AM'}" %>
            </span>
          </div>

          <%# Day Columns %>
          <% @week_start.upto(@week_end).each do |date| %>
            <div class="border-r p-2 min-h-[80px] relative">
              <%# Find shifts that start in this hour %>
              <% @shifts.select do |shift| 
                  shift.start_time.to_date == date && 
                  shift.start_time.hour == hour 
                end.each do |shift| %>
                <% 
                  # Calculate duration in hours
                  duration = ((shift.end_time - shift.start_time) / 1.hour).round
                  # Generate background color based on role
                  color_class = case shift.role
                    when 'manager' then 'bg-blue-100 border-blue-200'
                    when 'worker' then 'bg-green-100 border-green-200'
                    else 'bg-gray-100 border-gray-200'
                  end
                %>
                <div class="absolute left-0 right-0 mx-2 p-2 rounded border <%= color_class %>"
                     style="min-height: <%= [duration * 80, 60].max %>px">
                  <div class="text-sm font-medium truncate">
                    <%= shift.assigned_user&.full_name || 'Unassigned' %>
                  </div>
                  <div class="text-xs text-gray-600 truncate">
                    <%= shift.role.titleize %>
                  </div>
                  <div class="text-xs text-gray-500 truncate">
                    <%= shift.start_time.strftime("%I:%M %p") %> - 
                    <%= shift.end_time.strftime("%I:%M %p") %>
                  </div>
                  <div class="text-xs text-gray-500 truncate">
                    <%= shift.location %>
                  </div>
                </div>
              <% end %>
            </div>
          <% end %>
        </div>
      <% end %>
    </div>
  </div>

  <%# Legend %>
  <div class="mt-6 bg-white rounded-lg shadow p-4">
    <h3 class="text-lg font-medium text-gray-800 mb-3">Legend</h3>
    <div class="flex flex-wrap gap-4">
      <div class="flex items-center">
        <div class="w-4 h-4 bg-blue-100 border border-blue-200 rounded mr-2"></div>
        <span class="text-sm text-gray-600">Manager Shift</span>
      </div>
      <div class="flex items-center">
        <div class="w-4 h-4 bg-green-100 border border-green-200 rounded mr-2"></div>
        <span class="text-sm text-gray-600">Worker Shift</span>
      </div>
      <div class="flex items-center">
        <div class="w-4 h-4 bg-gray-100 border border-gray-200 rounded mr-2"></div>
        <span class="text-sm text-gray-600">Other Shifts</span>
      </div>
    </div>
  </div>
</div>